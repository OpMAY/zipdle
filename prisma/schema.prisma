generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // Zipdle Custom Fields
  role       String   @default("member") // "leader", "manager", "member"
  parts      String[] @default([]) // e.g., ["Vocal", "Guitar"]
  phone      String?
  created_at DateTime @default(now())

  // Relations
  added_songs          Song[]            @relation("AddedSongs")
  suggested_ideas      Idea[]            @relation("SuggestedIdeas")
  posts                Post[]            // Posts written by member
  comments             Comment[]         // Comments written by member
  schedule_attendances ScheduleAttendee[]
  idea_votes           IdeaVote[]
  post_likes           PostLike[]
  
  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String  @map("user_id")
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Song {
  id              String   @id @default(cuid())
  title           String
  artist          String
  status          String   // "practice", "complete", "hold", "wishlist"
  link            String?
  sheet_music_url String?
  lyrics          String?
  key             String?
  bpm             Int?
  memo            String?
  created_at      DateTime @default(now())

  added_by        String
  adder           User     @relation("AddedSongs", fields: [added_by], references: [id])
  setlist_songs   SetlistSong[]
}

model Schedule {
  id          String   @id @default(cuid())
  title       String
  type        String   // "practice", "gig", "meeting", "other"
  start_date  DateTime
  end_date    DateTime?
  location    String
  description String?
  setlist_id  String?
  setlist     Setlist? @relation(fields: [setlist_id], references: [id])
  
  attendees   ScheduleAttendee[]
}

model ScheduleAttendee {
  id          String   @id @default(cuid())
  schedule_id String
  member_id   String
  status      String   // "going", "not_going", "undecided"

  schedule    Schedule @relation(fields: [schedule_id], references: [id], onDelete: Cascade)
  member      User     @relation(fields: [member_id], references: [id], onDelete: Cascade)
  @@unique([schedule_id, member_id])
}

model Setlist {
  id          String   @id @default(cuid())
  title       String
  date        DateTime?
  description String?
  
  schedules   Schedule[]
  songs       SetlistSong[]
}

model SetlistSong {
  id         String   @id @default(cuid())
  setlist_id String
  song_id    String
  order      Int
  note       String?

  setlist    Setlist  @relation(fields: [setlist_id], references: [id], onDelete: Cascade)
  song       Song     @relation(fields: [song_id], references: [id], onDelete: Cascade)
  @@unique([setlist_id, song_id])
}

model Idea {
  id           String   @id @default(cuid())
  title        String
  artist       String
  link         String?
  comment      String?
  description  String?
  created_at   DateTime @default(now())

  suggested_by String
  suggester    User     @relation("SuggestedIdeas", fields: [suggested_by], references: [id])
  votes        IdeaVote[]
}

model IdeaVote {
  id        String @id @default(cuid())
  idea_id   String
  member_id String

  idea      Idea   @relation(fields: [idea_id], references: [id], onDelete: Cascade)
  member    User   @relation(fields: [member_id], references: [id], onDelete: Cascade)
  @@unique([idea_id, member_id])
}

model Post {
  id         String   @id @default(cuid())
  title      String
  content    String
  category   String   // "notice", "free", "gear"
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  author_id  String
  author     User     @relation(fields: [author_id], references: [id])
  likes      PostLike[]
  comments   Comment[]
}

model PostLike {
  id        String @id @default(cuid())
  post_id   String
  member_id String

  post      Post   @relation(fields: [post_id], references: [id], onDelete: Cascade)
  member    User   @relation(fields: [member_id], references: [id], onDelete: Cascade)
  @@unique([post_id, member_id])
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  created_at DateTime @default(now())
  
  post_id    String
  author_id  String

  post       Post     @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author     User     @relation(fields: [author_id], references: [id], onDelete: Cascade)
}
